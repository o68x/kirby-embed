(function(){"use strict";function f(e){const i=/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$/g,t=new RegExp(i);return!e||e.match(t)}function v(e,i){const t={youtube:/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,vimeo:/vimeo\.com\/([0-9]+)/,flickr:/^.*(flickr\.com)\/(.*)/,soundcloud:/^.*(soundcloud\.com|snd\.sc)\/(.*)/,twitter:/^.*(twitter\.com)\/(.*)/,instagram:/^.*(instagram\.com)\/(.*)/};return Object.keys(t).indexOf(i)==-1?!1:e.match(t[i])}var _=function(){var e=this,i=e.$createElement,t=e._self._c||i;return t("k-field",e._b({staticClass:"k-embed-field k-url-field k-field",style:e.$attrs.style,attrs:{input:e.id}},"k-field",e.$props,!1),[e.hasMedia?t("div",{staticClass:"preview",attrs:{"data-provider":e.providerName}},[t("div",{staticClass:"preview-content",domProps:{innerHTML:e._s(e.media.code)}}),t("div",{staticClass:"preview-background"})]):e._e(),t("k-input",e._b({ref:"input",attrs:{type:"url",value:e.inputValue},on:{input:e.onInput}},"k-input",e.$props,!1),[t("div",{staticClass:"k-embed-infos",attrs:{slot:"icon"},slot:"icon"},[t("div",{staticClass:"k-embed-status"},[e.loading?t("span",{staticClass:"k-embed-status-loading"},[t("span",{staticClass:"loader"})]):e.hasMedia?t("span",{staticClass:"k-embed-status-synced"},[e._v(e._s(e.$t("embed.synced"))+" "),t("span",{staticClass:"checkmark"})]):e.syncFailed?t("span",{staticClass:"k-embed-status-failed"},[e._v(e._s(e.$t("embed.failed"))+" "),t("span",{staticClass:"cross"})]):e._e()]),e.link?t("k-button",{staticClass:"k-input-icon-button",attrs:{icon:e.icon,link:e.inputValue,tooltip:e.$t("open"),tabindex:"-1",target:"_blank",rel:"noopener"}}):e._e()],1)])],1)},b=[],O="";function d(e,i,t,c,r,u,m,T){var s=typeof e=="function"?e.options:e;i&&(s.render=i,s.staticRenderFns=t,s._compiled=!0),c&&(s.functional=!0),u&&(s._scopeId="data-v-"+u);var n;if(m?(n=function(a){a=a||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!a&&typeof __VUE_SSR_CONTEXT__!="undefined"&&(a=__VUE_SSR_CONTEXT__),r&&r.call(this,a),a&&a._registeredComponents&&a._registeredComponents.add(m)},s._ssrRegister=n):r&&(n=T?function(){r.call(this,(s.functional?this.parent:this).$root.$options.shadowRoot)}:r),n)if(s.functional){s._injectStyles=n;var M=s.render;s.render=function(N,p){return n.call(p),M(N,p)}}else{var h=s.beforeCreate;s.beforeCreate=h?[].concat(h,n):[n]}return{exports:e,options:s}}const w={extends:"k-url-field",data(){return{media:Object,loading:!1}},props:{provider:String},created(){this.value&&this.value.media&&this.hasLength(this.value.media)&&(this.media=this.value.media)},watch:{value(){this.value&&this.value.media&&this.hasLength(this.value.media)?this.media=this.value.media:this.media={}}},computed:{hasMedia(){return this.hasLength(this.media)&&this.media.code},providerName(){return this.hasMedia&&this.media.providerName?this.media.providerName.toLowerCase():null},syncFailed(){return this.inputValue!=""&&this.isEmbeddableUrl(this.inputValue)&&!this.hasMedia},inputValue(){return this.value&&this.value.input?this.value.input:""}},methods:{onInput(e){if(e==""||!this.isEmbeddableUrl(e))return this.media={},this.emitInput(e),!1;e.includes("https://www.instagram.com")&&(e=e.split("?")[0].replace(/\/$/,"")),this.loading=!0,this.$api.get("kirby-embed/get-data",{url:e}).then(i=>{if(i.status=="success"&&i.data){if(i.data.providerName=="Vimeo"){let t=i.data.code;t=this.htmlToElement(t),t.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),i.data.code=t.outerHTML}this.media=i.data}else this.media={};this.emitInput(e)}).catch(i=>{this.media={},this.emitInput(e)})},emitInput(e){this.$emit("input",{input:e,media:this.media}),this.loading=!1,this.loadEmbedScripts()},isEmbeddableUrl(e){return!(!f(e)||this.provider&&!v(e,this.provider))},htmlToElement(e){let i=document.createElement("template");return e=e.trim(),i.innerHTML=e,i.content.firstChild},loadEmbedScripts(){if(window.twttr)window.twttr.widgets.load();else if(this.media&&Object.keys(this.media).length&&this.media.providerName.toLowerCase()=="twitter"){const e=document.createElement("script");e.src="https://platform.twitter.com/widgets.js",document.body.appendChild(e)}if(window.instgrm)window.instgrm.Embeds.process();else if(this.media&&Object.keys(this.media).length&&this.media.providerName.toLowerCase()=="instagram"){const e=document.createElement("script");e.src="https://www.instagram.com/embed.js",document.body.appendChild(e)}},hasLength(e){return Object.keys(e).length}}},o={};var g=d(w,_,b,!1,k,null,null,null);function k(e){for(let i in o)this[i]=o[i]}var C=function(){return g.exports}(),y=function(){var e=this,i=e.$createElement,t=e._self._c||i;return t("div",{staticClass:"k-embed-field-preview"},[t("div",{staticClass:"k-embed-field-preview-inner k-bubble",attrs:{"data-has-text":"true"}},[t("div",{staticClass:"k-embed-icon k-frame"},[t("img",{attrs:{src:e.iconSrc}})]),t("div",{staticClass:"k-embed-url"},[e._v(" "+e._s(e.url)+" ")])])])},$=[];const E={props:{value:String,field:Object},computed:{url(){return this.value.input.replace(/^\/\/|^.*?:\/\//,"").replace("www.","")},isSynced(){return Object.keys(this.value.media).length&&this.value.media.code!==null},iconSrc(){return this.$panel.urls.site+"/media/plugins/sylvainjule/embed/svg/"+this.providerIcon},providerIcon(){if(this.isSynced)if(this.field.icons){let e=this.value.media.providerName;return["Vimeo","Flickr","Instagram","SoundCloud","Spotify","Twitter","YouTube"].includes(e)?"embed-icon-"+e.toLowerCase()+".svg":"embed-icon-synced.svg"}else return"embed-icon-synced.svg";else return"embed-icon-failed.svg"}}},l={};var S=d(E,y,$,!1,j,null,null,null);function j(e){for(let i in l)this[i]=l[i]}var L=function(){return S.exports}();panel.plugin("sylvainjule/embed",{fields:{embed:C},components:{"k-embed-field-preview":L}})})();
